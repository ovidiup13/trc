# S3 storage provider

## Overview

The S3 provider stores artifacts in an S3-compatible bucket. Artifact metadata is stored as object metadata (size, duration, and optional tag).

## Configuration

```yaml
storage:
  provider: s3
  s3:
    endpoint: http://localhost:9000
    region: us-east-1
    bucket: trc-cache
    accessKeyId: your-access-key
    secretAccessKey: your-secret-key
    forcePathStyle: true
```

Required fields:

- `region`
- `bucket`
- `accessKeyId`
- `secretAccessKey`

Optional fields:

- `endpoint`: S3-compatible endpoint (use for MinIO or other vendors).
- `forcePathStyle`: set to `true` for MinIO and many S3-compatible services.
  - `true` uses path-style (`https://endpoint/bucket/key`).
  - `false` uses virtual-hosted style (`https://bucket.endpoint/key`).

Environment variables:

- Any config value can reference an environment variable using `$NAME` (see [docs/configuration.md](../configuration.md)).
- You can also override S3 config fields via `STORAGE_S3_*` environment variables.

Example (AWS S3):

```yaml
storage:
  provider: s3
  s3:
    region: us-east-1
    bucket: trc-cache
    accessKeyId: $AWS_ACCESS_KEY_ID
    secretAccessKey: $AWS_SECRET_ACCESS_KEY
```

Example (Cloudflare R2):

```yaml
storage:
  provider: s3
  s3:
    endpoint: $CLOUDFLARE_R2_ENDPOINT
    region: auto
    bucket: trc-cache
    accessKeyId: $CLOUDFLARE_ACCOUNT_ID
    secretAccessKey: $CLOUDFLARE_API_TOKEN
```

Example (MinIO):

```yaml
storage:
  provider: s3
  s3:
    endpoint: http://localhost:9000
    region: us-east-1
    bucket: trc-cache
    accessKeyId: minio-access
    secretAccessKey: minio-secret
    forcePathStyle: true
```

## Examples

Full config example (trc.yaml):

```yaml
server:
  host: 0.0.0.0
  port: 3000
logging:
  level: info
auth:
  type: jwt
  jwt:
    secret: super-secret
storage:
  provider: s3
  s3:
    endpoint: http://localhost:9000
    region: us-east-1
    bucket: trc-cache
    accessKeyId: your-access-key
    secretAccessKey: your-secret-key
    forcePathStyle: true
```

Full config example (trc.json):

```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 3000
  },
  "logging": {
    "level": "info"
  },
  "auth": {
    "type": "jwt",
    "jwt": {
      "secret": "super-secret"
    }
  },
  "storage": {
    "provider": "s3",
    "s3": {
      "endpoint": "http://localhost:9000",
      "region": "us-east-1",
      "bucket": "trc-cache",
      "accessKeyId": "your-access-key",
      "secretAccessKey": "your-secret-key",
      "forcePathStyle": true
    }
  }
}
```

## Setup

1. Create a bucket in your S3-compatible storage.
2. Ensure your credentials have read/write access to the bucket.
3. Point `TRC_CONFIG` to a config file that sets `storage.provider: s3`.
4. Start the server: `npx trc -c /path/to/trc.yaml`.

## Local testing with MinIO

This repo includes a MinIO-backed e2e test that provisions a bucket and runs a Turborepo example against the TRC server.

Run the e2e test:

```sh
bun run --filter @trc/e2e test:e2e
```

If you want to run MinIO manually:

```sh
docker run --rm -p 9000:9000 -p 9001:9001 \
  -e MINIO_ROOT_USER=minio-access \
  -e MINIO_ROOT_PASSWORD=minio-secret \
  minio/minio:latest server /data --console-address ":9001"
```

Then create a bucket with `mc` and point `endpoint` to `http://localhost:9000`.
