FROM oven/bun:1.3.6 AS builder

WORKDIR /repo

COPY . .

RUN --mount=type=cache,target=/root/.bun bun install --no-save
RUN bun build apps/server/src/index.ts --compile --outfile /repo/dist/trc-server

FROM gcr.io/distroless/base-debian12

WORKDIR /app

COPY --from=builder /repo/dist/trc-server /app/trc-server

ENV TRC_CONFIG=/config/trc.yaml

EXPOSE 3000

ENTRYPOINT ["/app/trc-server"]
